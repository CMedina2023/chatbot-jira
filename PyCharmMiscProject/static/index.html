<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Soporte Jira AI</title>
    <!-- Tailwind CSS CDN for quick and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- showdown.js for Markdown to HTML conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        /* Base styles for the body, using Inter font and a subtle gradient */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #6a11cb 0%, #2575fc 100%); /* Blue to purple gradient */
        }
        /* Styles for text in chat bubbles for better readability */
        .chat-bubble-text {
            line-height: 1.6; /* Increased line spacing */
            word-wrap: break-word; /* Ensures long words wrap */
        }
        /* Specific styles for Markdown-rendered content within chat bubbles */
        .chat-bubble-text p {
            margin-bottom: 0.5em; /* Space between paragraphs */
        }
        .chat-bubble-text ul, .chat-bubble-text ol {
            margin-left: 1.5em; /* Indent lists */
            margin-bottom: 0.5em;
        }
        .chat-bubble-text li {
            margin-bottom: 0.25em; /* Space between list items */
        }
        .chat-bubble-text strong {
            font-weight: 600; /* Make bold text stand out more */
        }
        /* Ensure the scrollbar is visible for chat history */
        #chat-history {
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: #9ca3af #f3f4f6; /* Thumb and track color */
        }
        #chat-history::-webkit-scrollbar {
            width: 8px; /* Width for Webkit browsers */
        }
        #chat-history::-webkit-scrollbar-track {
            background: #f3f4f6; /* Track color */
            border-radius: 10px;
        }
        #chat-history::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* Thumb color */
            border-radius: 10px;
            border: 2px solid #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <!-- Main chatbot container with card-like styles -->
    <!-- Increased max-w-xl for a wider chatbot and adjusted padding -->
    <div class="bg-white rounded-xl shadow-2xl p-10 max-w-xl w-full flex flex-col space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Asistente de Soporte Jira AI</h1>
        <p class="text-center text-gray-600 mb-6">¡Hola! Estoy aquí para ayudarte con tus consultas sobre Jira. Pregúntame lo que necesites.</p>

        <!-- Chat history area -->
        <!-- Adjusted max-h-96 for more visible height -->
        <div id="chat-history" class="flex flex-col space-y-4 overflow-y-auto max-h-[400px] p-4 bg-gray-50 rounded-lg border border-gray-200">
            <!-- Initial welcome message from the bot -->
            <div class="flex justify-start">
                <div class="bg-blue-100 text-blue-800 p-3 rounded-lg max-w-[80%] shadow chat-bubble-text">
                    Bienvenido. ¿En qué puedo ayudarte hoy?
                </div>
            </div>
            <!-- Messages will be added here dynamically -->
        </div>

        <!-- Text input form -->
        <form id="chatbot-form" class="flex flex-col space-y-4">
            <textarea
                id="pregunta"
                placeholder="Escribe tu consulta sobre Jira aquí..."
                rows="4"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 ease-in-out resize-none"
                required
            ></textarea>
            <button
                type="submit"
                id="send-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Enviar
            </button>
        </form>

        <!-- Loading indicator -->
        <div id="loading-indicator" class="hidden text-center text-blue-600 font-medium">
            Pensando... <span class="animate-pulse">_</span>
        </div>

        <!-- Error message (now with more styling for visibility) -->
        <div id="error-message" class="hidden text-center p-3 rounded-lg bg-red-100 text-red-800 font-semibold border border-red-300">
            <!-- Error message will be inserted here dynamically -->
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const chatForm = document.getElementById("chatbot-form");
        const preguntaInput = document.getElementById("pregunta");
        const chatHistoryDiv = document.getElementById("chat-history");
        const sendButton = document.getElementById("send-button");
        const loadingIndicator = document.getElementById("loading-indicator");
        const errorMessageDiv = document.getElementById("error-message");

        // Initialize showdown.js converter
        const converter = new showdown.Converter();

        // Define the API URL for your FastAPI backend (relative, as it's on the same domain)
        const apiUrl = window.location.origin + "/api/consultar";
        console.log("API URL configured:", apiUrl); // Debugging log

        /**
         * Adds a message to the chat history.
         * @param {string} sender - The sender of the message ('user' or 'bot').
         * @param {string} text - The text of the message.
         * @param {boolean} isMarkdown - True if the text should be parsed as Markdown.
         */
        function addMessage(sender, text, isMarkdown = false) {
            console.log(`Adding message from ${sender}: ${text}`); // Debugging log
            const messageDiv = document.createElement("div");
            // Adjust message alignment based on sender
            messageDiv.classList.add("flex", sender === "user" ? "justify-end" : "justify-start");

            const bubbleDiv = document.createElement("div");
            // Define basic styles that always apply
            bubbleDiv.classList.add("p-3", "rounded-lg", "max-w-[80%]", "shadow", "chat-bubble-text");

            // Apply specific colors based on sender
            if (sender === "user") {
                bubbleDiv.classList.add("bg-blue-600", "text-white");
            } else {
                bubbleDiv.classList.add("bg-gray-100", "text-gray-800");
            }

            // Set content, convert Markdown if specified
            if (isMarkdown) {
                bubbleDiv.innerHTML = converter.makeHtml(text); // Use innerHTML for Markdown
            } else {
                bubbleDiv.textContent = text; // Use textContent for plain text
            }

            messageDiv.appendChild(bubbleDiv);
            chatHistoryDiv.appendChild(messageDiv);

            // Automatically scroll to the bottom of the chat history
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        // Event handler for form submission
        chatForm.addEventListener("submit", async function(e) {
            e.preventDefault(); // Prevent default form submission (page reload)
            console.log("Form submitted."); // Debugging log

            const pregunta = preguntaInput.value.trim(); // Get user's question and remove whitespace
            if (!pregunta) {
                console.log("Empty question, not sending."); // Debugging log
                return; // If question is empty, do nothing
            }

            // 1. Display user's question in chat history (as plain text)
            addMessage("user", pregunta);

            // 2. Clear input field
            preguntaInput.value = "";

            // 3. Show loading indicator and disable send button
            loadingIndicator.classList.remove("hidden");
            sendButton.disabled = true;
            errorMessageDiv.classList.add("hidden"); // Hide any previous error message

            try {
                // 4. Prepare form data to send to backend
                const formData = new FormData();
                formData.append("pregunta", pregunta);
                console.log("Sending query to API..."); // Debugging log

                // 5. Make POST request to FastAPI API
                const response = await fetch(apiUrl, {
                    method: "POST",
                    body: formData
                });
                console.log("API response received."); // Debugging log

                // 6. Check if HTTP response was successful (2xx status code)
                if (!response.ok) {
                    const errorText = await response.text(); // Attempt to read error text
                    console.error("HTTP response error:", response.status, errorText); // Debugging log for HTTP error
                    throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
                }

                // 7. Parse JSON response from backend
                const data = await response.json();
                console.log('API Response data:', data); // Debugging log

                // 8. Display assistant's response in chat history (as Markdown)
                if (data.respuesta) {
                    addMessage("bot", data.respuesta, true); // Pass true for isMarkdown
                } else {
                    addMessage("bot", "La API devolvió una respuesta inesperada o vacía.");
                    console.error("API response missing 'respuesta' field:", data);
                }

            } catch (error) {
                // 9. Error handling for failed request
                console.error("Error consulting chatbot (in catch block):", error); // Debugging log for error in catch
                errorMessageDiv.textContent = `Ocurrió un error: ${error.message}. Por favor, inténtalo de nuevo.`;
                errorMessageDiv.classList.remove("hidden"); // Show error message to user
                // Optional: add a generic error message to chat
                addMessage("bot", "Lo siento, no pude procesar tu solicitud en este momento. Por favor, inténtalo de nuevo más tarde.");
            } finally {
                // 10. Hide loading indicator and enable send button, regardless of result
                loadingIndicator.classList.add("hidden");
                sendButton.disabled = false;
            }
        });
        // Ensure the initial welcome message is also rendered with Markdown if it contains any
        // Note: The welcome message is currently plain text, but this sets up for future.
        // The current welcome message in HTML is directly in the div, so no need to re-add.
        // addMessage("bot", "Bienvenido. ¿En qué puedo ayudarte hoy?", false);
    </script>
</body>
</html>
